

<!doctype html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>How to write a custom scan handling for specplot &#8212; spec2nexus 62.gbc635d3 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/bizstyle.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="spec2nexus.eznx" href="eznx.html" />
    <link rel="prev" title="spec2nexus.charts" href="charts.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="eznx.html" title="spec2nexus.eznx"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="charts.html" title="spec2nexus.charts"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">spec2nexus 62.gbc635d3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="contents.html" accesskey="U">Contents</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">How to write a custom scan handling for <em>specplot</em></a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="how-to-write-a-custom-scan-handling-for-specplot">
<span id="how-to-write-custom-scan-macro-handling"></span><h1>How to write a custom scan handling for <em>specplot</em><a class="headerlink" href="#how-to-write-a-custom-scan-handling-for-specplot" title="Permalink to this headline">¶</a></h1>
<p>Sometimes, it will be obvious that a certain scan macro never generates
any plot images, or that the default handling creates a plot that
is a poor representation of the data, such as the
<a class="reference internal" href="#custom-hklscan-specplot"><span class="std std-ref">hklscan</span></a> where
only one of the the axes <em>hkl</em> is scanned.  To pick the scanned axis
for plotting, it is necessary to prepare custom handling and replace
the default handling.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>It is possible to add in additional handling by writing a Python module.
This module creates a subclass of the standard handling, such as
<a class="reference internal" href="specplot.html#spec2nexus.specplot.LinePlotter" title="spec2nexus.specplot.LinePlotter"><code class="xref py py-class docutils literal notranslate"><span class="pre">LinePlotter</span></code></a>,
<a class="reference internal" href="specplot.html#spec2nexus.specplot.MeshPlotter" title="spec2nexus.specplot.MeshPlotter"><code class="xref py py-class docutils literal notranslate"><span class="pre">MeshPlotter</span></code></a>, or their superclass
<a class="reference internal" href="specplot.html#spec2nexus.specplot.ImageMaker" title="spec2nexus.specplot.ImageMaker"><code class="xref py py-class docutils literal notranslate"><span class="pre">ImageMaker</span></code></a>.
The support is added to the macro selection class
<a class="reference internal" href="specplot.html#spec2nexus.specplot.Selector" title="spec2nexus.specplot.Selector"><code class="xref py py-class docutils literal notranslate"><span class="pre">Selector</span></code></a> with code such as in the brief
example described below: <a class="reference internal" href="#custom-ascan-specplot"><span class="std std-ref">Change the plot title text in ascan macros</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">selector</span> <span class="o">=</span> <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">Selector</span><span class="p">()</span>
<span class="n">selector</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ascan&#39;</span><span class="p">,</span> <span class="n">Custom_Ascan</span><span class="p">)</span>
<span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot_gallery</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="data-model">
<h2>Data Model<a class="headerlink" href="#data-model" title="Permalink to this headline">¶</a></h2>
<p>The data to be plotted is kept in an appropriate subclass
of <code class="xref py py-class docutils literal notranslate"><span class="pre">PlotDataStructure</span></code> in attributes
show in the next table.  The data model is an adaptation of the
NeXus <em>NXdata</em> base class. <a class="footnote-reference brackets" href="#id3" id="id1">1</a></p>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 82%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>attribute</p></th>
<th class="head"><p>description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><cite>self.signal</cite></p></td>
<td><p>name of the dependent data (<em>y</em> axis or image) to be plotted</p></td>
</tr>
<tr class="row-odd"><td><p><cite>self.axes</cite></p></td>
<td><p>list of names of the independent axes <a class="footnote-reference brackets" href="#id4" id="id2">2</a></p></td>
</tr>
<tr class="row-even"><td><p><cite>self.data</cite></p></td>
<td><p>dictionary with the data, indexed by name</p></td>
</tr>
</tbody>
</table>
<dl class="footnote brackets">
<dt class="label" id="id3"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>NeXus <em>NXdata</em> base class:
<a class="reference external" href="http://download.nexusformat.org/doc/html/classes/base_classes/NXdata.html">http://download.nexusformat.org/doc/html/classes/base_classes/NXdata.html</a></p>
</dd>
<dt class="label" id="id4"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>The number of names provided in <cite>self.axes</cite> is equal to the <em>rank</em>
of the <em>signal</em> data (<cite>self.data[self.signal]</cite>).
For 1-D data, <cite>self.axes</cite> has one name and the <em>signal</em> data is one-dimensional.
For 2-D data, <cite>self.axes</cite> has two names and the <em>signal</em> data is two-dimensional.</p>
</dd>
</dl>
</section>
<section id="steps">
<h2>Steps<a class="headerlink" href="#steps" title="Permalink to this headline">¶</a></h2>
<p>In all cases, custom handling of a specific SPEC macro name is provided by
creating a subclass of <a class="reference internal" href="specplot.html#spec2nexus.specplot.ImageMaker" title="spec2nexus.specplot.ImageMaker"><code class="xref py py-class docutils literal notranslate"><span class="pre">ImageMaker</span></code></a> and defining
one or more of its methods.  In the simplest case, certain settings may be
changed by calling <code class="xref py py-meth docutils literal notranslate"><span class="pre">spec2nexus.specplot.ImageMaker.configure()</span></code> with
the custom values.  Examples of further customization are provided below, such
as when the data to be plotted is stored outside of the SPEC data file.  This
is common for images from area detectors.</p>
<p>It may also be necessary to create a subclass
of <code class="xref py py-class docutils literal notranslate"><span class="pre">PlotDataStructure</span></code> to gather the data to be plotted
or override the default <a class="reference internal" href="specplot.html#spec2nexus.specplot.ImageMaker.plottable" title="spec2nexus.specplot.ImageMaker.plottable"><code class="xref py py-meth docutils literal notranslate"><span class="pre">spec2nexus.specplot.ImageMaker.plottable()</span></code></a> method.
An example of this is shown with the <a class="reference internal" href="specplot.html#spec2nexus.specplot.MeshPlotter" title="spec2nexus.specplot.MeshPlotter"><code class="xref py py-class docutils literal notranslate"><span class="pre">MeshPlotter</span></code></a> and
associated <code class="xref py py-class docutils literal notranslate"><span class="pre">MeshStructure</span></code> classes.</p>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>A few exmaples of custom macro handling are provided, some simple, some complex.
In each example, decisions have been made about where to provide the desired features.</p>
<section id="change-the-plot-title-text-in-ascan-macros">
<span id="custom-ascan-specplot"></span><h3>Change the plot title text in <em>ascan</em> macros<a class="headerlink" href="#change-the-plot-title-text-in-ascan-macros" title="Permalink to this headline">¶</a></h3>
<p>The SPEC <em>ascan</em> macro is a workhorse and records the scan
of a positioner and the measurement of data in a counter.
Since this macro name ends with “scan”, the default selection
in <em>specplot</em> images this data
using the <a class="reference internal" href="specplot.html#spec2nexus.specplot.LinePlotter" title="spec2nexus.specplot.LinePlotter"><code class="xref py py-class docutils literal notranslate"><span class="pre">LinePlotter</span></code></a> class.
Here is a plot of the default handling of data from the <em>ascan</em> macro:</p>
<figure class="align-default" id="id7">
<a class="reference internal image-reference" href="_images/ascan.png"><img alt="_images/ascan.png" src="_images/ascan.png" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">Standard plot of data from <em>ascan</em> macro</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>We will show how to change the plot title as a means to illustrate
how to customize the handling for a scan macro.</p>
<p>We write <code class="xref py py-class docutils literal notranslate"><span class="pre">Custom_Ascan</span></code> which is a subclass of
<a class="reference internal" href="specplot.html#spec2nexus.specplot.LinePlotter" title="spec2nexus.specplot.LinePlotter"><code class="xref py py-class docutils literal notranslate"><span class="pre">LinePlotter</span></code></a>.  The <code class="xref py py-mod docutils literal notranslate"><span class="pre">get_plot_data</span></code> method is written
(overrides the default method) to gain access to the place
where we can introduce the change.  The change is made by the call to
the <code class="xref py py-mod docutils literal notranslate"><span class="pre">configure</span></code> method (defined in the superclass).  Here’s the code:</p>
<p class="rubric"><cite>ascan.py</cite> example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="ch">#!/usr/bin/env python</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="sd">&#39;&#39;&#39;</span>
<span class="lineno"> 4 </span><span class="sd">Plot all scans that used the SPEC `ascan` macro, showing only the scan number (not full scan command)</span>
<span class="lineno"> 5 </span>
<span class="lineno"> 6 </span><span class="sd">This is a simple example of how to customize the scan macro handling.</span>
<span class="lineno"> 7 </span><span class="sd">There are many more ways to add complexity.</span>
<span class="lineno"> 8 </span><span class="sd">&#39;&#39;&#39;</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="kn">import</span> <span class="nn">spec2nexus.specplot</span>
<span class="lineno">11 </span><span class="kn">import</span> <span class="nn">spec2nexus.specplot_gallery</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span>
<span class="lineno">14 </span><span class="k">class</span> <span class="nc">Custom_Ascan</span><span class="p">(</span><span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">LinePlotter</span><span class="p">):</span>
<span class="lineno">15 </span>    <span class="sd">&#39;&#39;&#39;simple customization&#39;&#39;&#39;</span>
<span class="lineno">16 </span>    
<span class="lineno">17 </span>    <span class="k">def</span> <span class="nf">retrieve_plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">18 </span>        <span class="sd">&#39;&#39;&#39;substitute with the data&amp;time the plot was created&#39;&#39;&#39;</span>
<span class="lineno">19 </span>        <span class="kn">import</span> <span class="nn">datetime</span>
<span class="lineno">20 </span>        <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">LinePlotter</span><span class="o">.</span><span class="n">retrieve_plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="lineno">21 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_plot_subtitle</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
<span class="lineno">22 </span>
<span class="lineno">23 </span>
<span class="lineno">24 </span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="lineno">25 </span>    <span class="n">selector</span> <span class="o">=</span> <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">Selector</span><span class="p">()</span>
<span class="lineno">26 </span>    <span class="n">selector</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ascan&#39;</span><span class="p">,</span> <span class="n">Custom_Ascan</span><span class="p">)</span>
<span class="lineno">27 </span>    <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot_gallery</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
<span class="lineno">28 </span>
<span class="lineno">29 </span>
<span class="lineno">30 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="lineno">31 </span>    <span class="n">main</span><span class="p">()</span>
<span class="lineno">32 </span>
<span class="lineno">33 </span><span class="c1"># -----------------------------------------------------------------------------</span>
<span class="lineno">34 </span><span class="c1"># :author:    Pete R. Jemian</span>
<span class="lineno">35 </span><span class="c1"># :email:     prjemian@gmail.com</span>
<span class="lineno">36 </span><span class="c1"># :copyright: (c) 2014-2022, Pete R. Jemian</span>
<span class="lineno">37 </span><span class="c1">#</span>
<span class="lineno">38 </span><span class="c1"># Distributed under the terms of the Creative Commons Attribution 4.0 International Public License.</span>
<span class="lineno">39 </span><span class="c1">#</span>
<span class="lineno">40 </span><span class="c1"># The full license is in the file LICENSE.txt, distributed with this software.</span>
<span class="lineno">41 </span><span class="c1"># -----------------------------------------------------------------------------</span>
</pre></div>
</div>
<p>See the changed title:</p>
<figure class="align-default" id="id8">
<a class="reference internal image-reference" href="_images/ascan_custom.png"><img alt="_images/ascan_custom.png" src="_images/ascan_custom.png" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">Customized plot of data from <em>ascan</em> macro</span><a class="headerlink" href="#id8" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="make-the-y-axis-log-scale">
<span id="custom-y-log-specplot"></span><h3>Make the <em>y</em>-axis log scale<a class="headerlink" href="#make-the-y-axis-log-scale" title="Permalink to this headline">¶</a></h3>
<p>A very simple customization can make the Y axis to be logarithmic scale.
(This customization is planned for an added feature <a class="footnote-reference brackets" href="#id6" id="id5">3</a> in a future relase of the
<em>spec2nexus</em> package.)  We present two examples.</p>
<section id="modify-handling-of-a2scan">
<h4>modify handling of <cite>a2scan</cite><a class="headerlink" href="#modify-handling-of-a2scan" title="Permalink to this headline">¶</a></h4>
<p>One user wants all the <cite>a2scan</cite> images to be plotted with a logarithmic
scale on the Y axis.  Here’s the code:</p>
<p class="rubric"><cite>custom_a2scan_gallery.py</cite> example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="ch">#!/usr/bin/env python</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="sd">&#39;&#39;&#39;</span>
<span class="lineno"> 4 </span><span class="sd">Customization for specplot_gallery: plot a2scan with log(y) axis</span>
<span class="lineno"> 5 </span>
<span class="lineno"> 6 </span><span class="sd">This program changes the plotting for all scans that used the *a2scan* SPEC macro.</span>
<span class="lineno"> 7 </span><span class="sd">The Y axis of these plots will be plotted as logarithmic if all the data values are </span>
<span class="lineno"> 8 </span><span class="sd">greater than zero.  Otherwise, the Y axis scale will be linear.</span>
<span class="lineno"> 9 </span><span class="sd">&#39;&#39;&#39;</span>
<span class="lineno">10 </span>
<span class="lineno">11 </span><span class="kn">import</span> <span class="nn">spec2nexus.specplot</span>
<span class="lineno">12 </span><span class="kn">import</span> <span class="nn">spec2nexus.specplot_gallery</span>
<span class="lineno">13 </span>
<span class="lineno">14 </span><span class="k">class</span> <span class="nc">Custom_a2scan_Plotter</span><span class="p">(</span><span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">LinePlotter</span><span class="p">):</span>
<span class="lineno">15 </span>    <span class="sd">&#39;&#39;&#39;plot `a2scan` y axis as log if possible&#39;&#39;&#39;</span>
<span class="lineno">16 </span>    
<span class="lineno">17 </span>    <span class="k">def</span> <span class="nf">retrieve_plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">18 </span>        <span class="sd">&#39;&#39;&#39;plot the vertical axis on log scale&#39;&#39;&#39;</span>
<span class="lineno">19 </span>        <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">LinePlotter</span><span class="o">.</span><span class="n">retrieve_plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="lineno">20 </span>
<span class="lineno">21 </span>        <span class="n">choose_log_scale</span> <span class="o">=</span> <span class="bp">False</span>
<span class="lineno">22 </span>
<span class="lineno">23 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>    <span class="c1"># log(y) if all data positive</span>
<span class="lineno">24 </span>            <span class="n">choose_log_scale</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="lineno">25 </span>
<span class="lineno">26 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_y_log</span><span class="p">(</span><span class="n">choose_log_scale</span><span class="p">)</span>
<span class="lineno">27 </span>
<span class="lineno">28 </span>
<span class="lineno">29 </span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="lineno">30 </span>    <span class="n">selector</span> <span class="o">=</span> <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">Selector</span><span class="p">()</span>
<span class="lineno">31 </span>    <span class="n">selector</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;a2scan&#39;</span><span class="p">,</span> <span class="n">Custom_a2scan_Plotter</span><span class="p">)</span>
<span class="lineno">32 </span>    <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot_gallery</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
<span class="lineno">33 </span>
<span class="lineno">34 </span>
<span class="lineno">35 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="lineno">36 </span>    <span class="c1"># debugging_setup()</span>
<span class="lineno">37 </span>    <span class="n">main</span><span class="p">()</span>
<span class="lineno">38 </span>
<span class="lineno">39 </span><span class="sd">&#39;&#39;&#39;</span>
<span class="lineno">40 </span><span class="sd">Instructions:</span>
<span class="lineno">41 </span>
<span class="lineno">42 </span><span class="sd">Save this file in a directory you can write and call it from your cron tasks.  </span>
<span class="lineno">43 </span>
<span class="lineno">44 </span><span class="sd">Note that in cron entries, you cannot rely on shell environment variables to </span>
<span class="lineno">45 </span><span class="sd">be defined.  Best to spell things out completely.  For example, if your $HOME </span>
<span class="lineno">46 </span><span class="sd">directory is `/home/user` and you have these directories:</span>
<span class="lineno">47 </span>
<span class="lineno">48 </span><span class="sd">* `/home/user/bin`: various custom executables you use</span>
<span class="lineno">49 </span><span class="sd">* `/home/user/www/specplots`: a directory you access with a web browser for your plots</span>
<span class="lineno">50 </span><span class="sd">* `/home/user/spec/data`: a directory with your SPEC data files</span>
<span class="lineno">51 </span>
<span class="lineno">52 </span><span class="sd">then save this file to `/home/user/bin/custom_a2scan_gallery.py` and make it executable</span>
<span class="lineno">53 </span><span class="sd">(using `chmod +x ./home/user/bin/custom_a2scan_gallery.py`).</span>
<span class="lineno">54 </span>
<span class="lineno">55 </span><span class="sd">Edit your list of cron tasks using `crontab -e` and add this (possibly </span>
<span class="lineno">56 </span><span class="sd">replacing a call to `specplot_gallery` with this call `custom_a2scan_gallery.py`)::</span>
<span class="lineno">57 </span>
<span class="lineno">58 </span><span class="sd">    # every five minutes (generates no output from outer script)</span>
<span class="lineno">59 </span><span class="sd">    0-59/5 * * * *  /home/user/bin/custom_a2scan_gallery.py -d /home/user/www/specplots /home/user/spec/data 2&gt;&amp;1 &gt;&gt; /home/user/www/specplots/log_cron.txt</span>
<span class="lineno">60 </span>
<span class="lineno">61 </span><span class="sd">Any output from this periodic task will be recorded in the file</span>
<span class="lineno">62 </span><span class="sd">`/home/user/www/specplots/log_cron.txt`.  This file can be reviewed</span>
<span class="lineno">63 </span><span class="sd">for diagnostics or troubleshooting.</span>
<span class="lineno">64 </span><span class="sd">&#39;&#39;&#39;</span>
</pre></div>
</div>
</section>
<section id="custom-uascan">
<h4>custom <cite>uascan</cite><a class="headerlink" href="#custom-uascan" title="Permalink to this headline">¶</a></h4>
<p>The APS USAXS instrument uses a custom scan macro called <em>uascan</em> for routine step scans.
Since this macro name ends with “scan”, the default selection in <em>specplot</em> images this data
using the <a class="reference internal" href="specplot.html#spec2nexus.specplot.LinePlotter" title="spec2nexus.specplot.LinePlotter"><code class="xref py py-class docutils literal notranslate"><span class="pre">LinePlotter</span></code></a> class.
Here is a plot of the default handling of data from the <em>uascan</em> macro:</p>
<figure class="align-default" id="id9">
<a class="reference internal image-reference" href="_images/uascan_as_ascan.png"><img alt="_images/uascan_as_ascan.png" src="_images/uascan_as_ascan.png" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">USAXS <em>uascan</em>, handled as <a class="reference internal" href="specplot.html#spec2nexus.specplot.LinePlotter" title="spec2nexus.specplot.LinePlotter"><code class="xref py py-class docutils literal notranslate"><span class="pre">LinePlotter</span></code></a></span><a class="headerlink" href="#id9" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The can be changed by making the <em>y</em> axis log scale.
To do this, a custom version of <a class="reference internal" href="specplot.html#spec2nexus.specplot.LinePlotter" title="spec2nexus.specplot.LinePlotter"><code class="xref py py-class docutils literal notranslate"><span class="pre">LinePlotter</span></code></a>
is created as <code class="xref py py-class docutils literal notranslate"><span class="pre">Custom_Ascan</span></code>.  The <code class="xref py py-mod docutils literal notranslate"><span class="pre">get_plot_data</span></code> method is written
(overrides the default method) to make the <em>y</em> axis log-scale by calling
the <code class="xref py py-mod docutils literal notranslate"><span class="pre">configure</span></code> method (defined in the superclass).  Here’s the code:</p>
<p class="rubric"><cite>usaxs_uascan.py</cite> example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="ch">#!/usr/bin/env python</span>
<span class="lineno"> 2 </span>
<span class="lineno"> 3 </span><span class="sd">&#39;&#39;&#39;</span>
<span class="lineno"> 4 </span><span class="sd">Plot data from the USAXS uascan macro</span>
<span class="lineno"> 5 </span>
<span class="lineno"> 6 </span><span class="sd">.. autosummary::</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="sd">    ~UAscan_Plotter</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="sd">&#39;&#39;&#39;</span>
<span class="lineno">11 </span>
<span class="lineno">12 </span><span class="kn">import</span> <span class="nn">spec2nexus.specplot</span>
<span class="lineno">13 </span><span class="kn">import</span> <span class="nn">spec2nexus.specplot_gallery</span>
<span class="lineno">14 </span>
<span class="lineno">15 </span>
<span class="lineno">16 </span><span class="k">class</span> <span class="nc">UAscan_Plotter</span><span class="p">(</span><span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">LinePlotter</span><span class="p">):</span>
<span class="lineno">17 </span>    <span class="sd">&#39;&#39;&#39;simple customize of `uascan` handling&#39;&#39;&#39;</span>
<span class="lineno">18 </span>    
<span class="lineno">19 </span>    <span class="k">def</span> <span class="nf">retrieve_plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">20 </span>        <span class="sd">&#39;&#39;&#39;plot the vertical axis on log scale&#39;&#39;&#39;</span>
<span class="lineno">21 </span>        <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">LinePlotter</span><span class="o">.</span><span class="n">retrieve_plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="lineno">22 </span>
<span class="lineno">23 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
<span class="lineno">24 </span>            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">25 </span>                <span class="c1"># TODO: remove any data where Y &lt;= 0 (can&#39;t plot on log scale)</span>
<span class="lineno">26 </span>                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;cannot plot Y&lt;0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">)</span>
<span class="lineno">27 </span>                <span class="k">raise</span> <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">NotPlottable</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="lineno">28 </span>
<span class="lineno">29 </span>        <span class="c1"># in the uascan, a name for the sample is given in `self.scan.comments[0]`</span>
<span class="lineno">30 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_y_log</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="lineno">31 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_plot_subtitle</span><span class="p">(</span>
<span class="lineno">32 </span>            <span class="s1">&#39;#</span><span class="si">%s</span><span class="s1"> uascan: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanNum</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="lineno">33 </span>
<span class="lineno">34 </span>
<span class="lineno">35 </span><span class="k">def</span> <span class="nf">debugging_setup</span><span class="p">():</span>
<span class="lineno">36 </span>    <span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="lineno">37 </span>    <span class="kn">import</span> <span class="nn">shutil</span>
<span class="lineno">38 </span>    <span class="kn">import</span> <span class="nn">ascan</span>
<span class="lineno">39 </span>    <span class="n">selector</span> <span class="o">=</span> <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">Selector</span><span class="p">()</span>
<span class="lineno">40 </span>    <span class="n">selector</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ascan&#39;</span><span class="p">,</span> <span class="n">ascan</span><span class="o">.</span><span class="n">Custom_Ascan</span><span class="p">)</span>   <span class="c1"># just for the demo</span>
<span class="lineno">41 </span>    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;__usaxs__&#39;</span>
<span class="lineno">42 </span>    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="lineno">43 </span>    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="lineno">44 </span>    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">)</span>
<span class="lineno">45 </span>    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="lineno">46 </span>    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;spec2nexus&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;APS_spec_data.dat&#39;</span><span class="p">))</span>
<span class="lineno">47 </span>
<span class="lineno">48 </span>
<span class="lineno">49 </span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="lineno">50 </span>    <span class="n">selector</span> <span class="o">=</span> <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">Selector</span><span class="p">()</span>
<span class="lineno">51 </span>    <span class="n">selector</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;uascan&#39;</span><span class="p">,</span> <span class="n">UAscan_Plotter</span><span class="p">)</span>
<span class="lineno">52 </span>    <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot_gallery</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
<span class="lineno">53 </span>
<span class="lineno">54 </span>
<span class="lineno">55 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="lineno">56 </span>    <span class="c1"># debugging_setup()</span>
<span class="lineno">57 </span>    <span class="n">main</span><span class="p">()</span>
<span class="lineno">58 </span>
<span class="lineno">59 </span><span class="c1"># -----------------------------------------------------------------------------</span>
<span class="lineno">60 </span><span class="c1"># :author:    Pete R. Jemian</span>
<span class="lineno">61 </span><span class="c1"># :email:     prjemian@gmail.com</span>
<span class="lineno">62 </span><span class="c1"># :copyright: (c) 2014-2022, Pete R. Jemian</span>
<span class="lineno">63 </span><span class="c1">#</span>
<span class="lineno">64 </span><span class="c1"># Distributed under the terms of the Creative Commons Attribution 4.0 International Public License.</span>
<span class="lineno">65 </span><span class="c1">#</span>
<span class="lineno">66 </span><span class="c1"># The full license is in the file LICENSE.txt, distributed with this software.</span>
<span class="lineno">67 </span><span class="c1"># -----------------------------------------------------------------------------</span>
</pre></div>
</div>
<p>Note that in the <em>uascan</em>, a name for the sample provided by the user
is given in <cite>self.scan.comments[0]</cite>.  The plot title is changed to
include this and the scan number.
The customized plot has a logarithmic <em>y</em> axis:</p>
<figure class="align-default" id="id10">
<a class="reference internal image-reference" href="_images/uascan_log_y.png"><img alt="_images/uascan_log_y.png" src="_images/uascan_log_y.png" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">USAXS <em>uascan</em>, with logarithmic <em>y</em> axis</span><a class="headerlink" href="#id10" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The most informative view of this data is when the raw data are
reduced to <span class="math notranslate nohighlight">\(I(Q)\)</span> and viewed on a log-log plot,
but that process is beyond this simple example.
See the example <a class="reference internal" href="#custom-usaxs-specplot"><span class="std std-ref">Get xy data from HDF5 file</span></a> below.</p>
<dl class="footnote brackets">
<dt class="label" id="id6"><span class="brackets"><a class="fn-backref" href="#id5">3</a></span></dt>
<dd><p><a class="reference external" href="https://github.com/prjemian/spec2nexus/issues/102">specplot: add option for default log(signal)</a></p>
</dd>
</dl>
</section>
</section>
<section id="spec-s-hklscan-macro">
<span id="custom-hklscan-specplot"></span><h3>SPEC’s <em>hklscan</em> macro<a class="headerlink" href="#spec-s-hklscan-macro" title="Permalink to this headline">¶</a></h3>
<p>The SPEC <em>hklscan</em> macro appears in a SPEC data file due to
either a <em>hscan</em>, <em>kscan</em>, or <em>lscan</em>.  In each of these one of the <em>hkl</em>
vectors is scanned while the other two remain constant.</p>
<p>The normal handling of the <em>ascan</em> macro plots the last data column
against the first.  This works for data collected with the <em>hscan</em>.
For <em>kscan</em> or <em>lscan</em> macros, the <em>h</em> axis is still plotted by default
since it is in the first column.</p>
<figure class="align-default" id="id11">
<a class="reference internal image-reference" href="_images/hklscan_as_ascan.png"><img alt="_images/hklscan_as_ascan.png" src="_images/hklscan_as_ascan.png" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">SPEC <em>hklscan</em> (<em>lscan</em>, in this case), plotted against the (default) first axis <em>H</em></span><a class="headerlink" href="#id11" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>To display the scanned axis, it is necessary to examine the data in a custom
subclass of <a class="reference internal" href="specplot.html#spec2nexus.specplot.LinePlotter" title="spec2nexus.specplot.LinePlotter"><code class="xref py py-class docutils literal notranslate"><span class="pre">LinePlotter</span></code></a>.  The
<a class="reference internal" href="specplot.html#spec2nexus.specplot.HKLScanPlotter" title="spec2nexus.specplot.HKLScanPlotter"><code class="xref py py-class docutils literal notranslate"><span class="pre">HKLScanPlotter</span></code></a> subclass,
provided with <em>specplot</em>, defines the <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_plot_data()</span></code> method
determines the scanned axis, setting it by name:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axis</span><span class="p">,]</span>
<span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">column_first</span> <span class="o">=</span> <span class="n">axis</span>
</pre></div>
</div>
<p>Then, the standard plot handling used by <em>LinePlotter</em>
uses this information to make the plot.</p>
<figure class="align-default" id="id12">
<a class="reference internal image-reference" href="_images/hklscan.png"><img alt="_images/hklscan.png" src="_images/hklscan.png" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">SPEC <em>hklscan</em> (<em>lscan</em>), plotted against <em>L</em></span><a class="headerlink" href="#id12" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="get-xy-data-from-hdf5-file">
<span id="custom-usaxs-specplot"></span><h3>Get <em>xy</em> data from HDF5 file<a class="headerlink" href="#get-xy-data-from-hdf5-file" title="Permalink to this headline">¶</a></h3>
<p>One example of complexity is when SPEC has been used to direct data collection
but the data is not stored in the SPEC data file.  The SPEC data file scan
must provide some indication about where the collected scan data has been stored.</p>
<p>The USAXS instrument at APS has a <em>FlyScan</em> macro that commands the instrument
to collect data continuously over the desired <span class="math notranslate nohighlight">\(Q\)</span> range.  The data is written
to a NeXus HDF5 data file.  Later, a data reduction process converts the arrays of
raw data to one-dimensional <span class="math notranslate nohighlight">\(I(Q)\)</span> profiles.  The best representation of this
reduced data is on a log-log plot to reveal the many decades of both <span class="math notranslate nohighlight">\(I\)</span> and
<span class="math notranslate nohighlight">\(Q\)</span> covered by the measurement.</p>
<p>With the default handling by <a class="reference internal" href="specplot.html#spec2nexus.specplot.LinePlotter" title="spec2nexus.specplot.LinePlotter"><code class="xref py py-class docutils literal notranslate"><span class="pre">LinePlotter</span></code></a>, no plot
can be generated since the dfata is given in a separate HDF5 file.  That file
is read with the custom handling of the <cite>usaxs_flyscan.py</cite> demo:</p>
<p class="rubric"><cite>usaxs_flyscan.py</cite> example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno">  1 </span><span class="ch">#!/usr/bin/env python</span>
<span class="lineno">  2 </span>
<span class="lineno">  3 </span><span class="sd">&#39;&#39;&#39;</span>
<span class="lineno">  4 </span><span class="sd">Plot data from the USAXS FlyScan macro</span>
<span class="lineno">  5 </span>
<span class="lineno">  6 </span><span class="sd">.. autosummary::</span>
<span class="lineno">  7 </span>
<span class="lineno">  8 </span><span class="sd">    ~read_reduced_fly_scan_file</span>
<span class="lineno">  9 </span><span class="sd">    ~retrieve_flyScanData</span>
<span class="lineno"> 10 </span><span class="sd">    ~USAXS_FlyScan_Structure</span>
<span class="lineno"> 11 </span><span class="sd">    ~USAXS_FlyScan_Plotter</span>
<span class="lineno"> 12 </span>
<span class="lineno"> 13 </span><span class="sd">&#39;&#39;&#39;</span>
<span class="lineno"> 14 </span>
<span class="lineno"> 15 </span><span class="kn">import</span> <span class="nn">h5py</span>
<span class="lineno"> 16 </span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="lineno"> 17 </span><span class="kn">import</span> <span class="nn">os</span>
<span class="lineno"> 18 </span>
<span class="lineno"> 19 </span><span class="kn">import</span> <span class="nn">spec2nexus.specplot</span>
<span class="lineno"> 20 </span><span class="kn">import</span> <span class="nn">spec2nexus.specplot_gallery</span>
<span class="lineno"> 21 </span>
<span class="lineno"> 22 </span>
<span class="lineno"> 23 </span><span class="c1"># methods picked (&amp; modified) from the USAXS livedata project</span>
<span class="lineno"> 24 </span><span class="k">def</span> <span class="nf">read_reduced_fly_scan_file</span><span class="p">(</span><span class="n">hdf5_file_name</span><span class="p">):</span>
<span class="lineno"> 25 </span>    <span class="sd">&#39;&#39;&#39;</span>
<span class="lineno"> 26 </span><span class="sd">    read any and all reduced data from the HDF5 file, return in a dictionary</span>
<span class="lineno"> 27 </span><span class="sd">    </span>
<span class="lineno"> 28 </span><span class="sd">    dictionary = {</span>
<span class="lineno"> 29 </span><span class="sd">      &#39;full&#39;: dict(Q, R, R_max, ar, fwhm, centroid)</span>
<span class="lineno"> 30 </span><span class="sd">      &#39;250&#39;:  dict(Q, R, dR)</span>
<span class="lineno"> 31 </span><span class="sd">      &#39;5000&#39;: dict(Q, R, dR)</span>
<span class="lineno"> 32 </span><span class="sd">    }</span>
<span class="lineno"> 33 </span><span class="sd">    &#39;&#39;&#39;</span>
<span class="lineno"> 34 </span>
<span class="lineno"> 35 </span>    <span class="n">reduced</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno"> 36 </span>    <span class="n">hdf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hdf5_file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="lineno"> 37 </span>    <span class="n">entry</span> <span class="o">=</span> <span class="n">hdf</span><span class="p">[</span><span class="s1">&#39;/entry&#39;</span><span class="p">]</span>
<span class="lineno"> 38 </span>    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">entry</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<span class="lineno"> 39 </span>        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;flyScan_reduced_&#39;</span><span class="p">):</span>
<span class="lineno"> 40 </span>            <span class="n">nxdata</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<span class="lineno"> 41 </span>            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno"> 42 </span>            <span class="k">for</span> <span class="n">dsname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">]:</span>
<span class="lineno"> 43 </span>                <span class="k">if</span> <span class="n">dsname</span> <span class="ow">in</span> <span class="n">nxdata</span><span class="p">:</span>
<span class="lineno"> 44 </span>                    <span class="n">value</span> <span class="o">=</span> <span class="n">nxdata</span><span class="p">[</span><span class="n">dsname</span><span class="p">]</span>
<span class="lineno"> 45 </span>                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="lineno"> 46 </span>                        <span class="n">d</span><span class="p">[</span><span class="n">dsname</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="lineno"> 47 </span>                    <span class="k">else</span><span class="p">:</span>
<span class="lineno"> 48 </span>                        <span class="n">d</span><span class="p">[</span><span class="n">dsname</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="lineno"> 49 </span>            <span class="n">reduced</span><span class="p">[</span><span class="n">key</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;flyScan_reduced_&#39;</span><span class="p">):]]</span> <span class="o">=</span> <span class="n">d</span>
<span class="lineno"> 50 </span>    <span class="n">hdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="lineno"> 51 </span>    <span class="k">return</span> <span class="n">reduced</span>
<span class="lineno"> 52 </span>
<span class="lineno"> 53 </span>
<span class="lineno"> 54 </span><span class="c1"># $URL: https://subversion.xray.aps.anl.gov/small_angle/USAXS/livedata/specplot.py $</span>
<span class="lineno"> 55 </span><span class="n">REDUCED_FLY_SCAN_BINS</span>   <span class="o">=</span> <span class="mi">250</span>       <span class="c1"># the default</span>
<span class="lineno"> 56 </span><span class="k">def</span> <span class="nf">retrieve_flyScanData</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="lineno"> 57 </span>    <span class="sd">&#39;&#39;&#39;retrieve reduced, rebinned data from USAXS Fly Scans&#39;&#39;&#39;</span>
<span class="lineno"> 58 </span>    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">fileName</span><span class="p">)</span>
<span class="lineno"> 59 </span>    <span class="n">key_string</span> <span class="o">=</span> <span class="s1">&#39;FlyScan file name = &#39;</span>
<span class="lineno"> 60 </span>    <span class="n">comment</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="lineno"> 61 </span>    <span class="n">index</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">key_string</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_string</span><span class="p">)</span>
<span class="lineno"> 62 </span>    <span class="n">hdf_file_name</span> <span class="o">=</span> <span class="n">comment</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="lineno"> 63 </span>    <span class="n">abs_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">hdf_file_name</span><span class="p">))</span>
<span class="lineno"> 64 </span>
<span class="lineno"> 65 </span>    <span class="n">plotData</span> <span class="o">=</span> <span class="p">{}</span>
<span class="lineno"> 66 </span>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">abs_file</span><span class="p">):</span>
<span class="lineno"> 67 </span>        <span class="n">reduced</span> <span class="o">=</span> <span class="n">read_reduced_fly_scan_file</span><span class="p">(</span><span class="n">abs_file</span><span class="p">)</span>
<span class="lineno"> 68 </span>        <span class="n">s_num_bins</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">REDUCED_FLY_SCAN_BINS</span><span class="p">)</span>
<span class="lineno"> 69 </span>
<span class="lineno"> 70 </span>        <span class="n">choice</span> <span class="o">=</span> <span class="n">reduced</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s_num_bins</span><span class="p">)</span> <span class="ow">or</span> <span class="n">reduced</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;full&#39;</span><span class="p">)</span>
<span class="lineno"> 71 </span>
<span class="lineno"> 72 </span>        <span class="k">if</span> <span class="n">choice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<span class="lineno"> 73 </span>            <span class="n">plotData</span> <span class="o">=</span> <span class="p">{</span><span class="n">axis</span><span class="p">:</span> <span class="n">choice</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="s1">&#39;Q R&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()}</span>
<span class="lineno"> 74 </span>
<span class="lineno"> 75 </span>    <span class="k">return</span> <span class="n">plotData</span>
<span class="lineno"> 76 </span>
<span class="lineno"> 77 </span>
<span class="lineno"> 78 </span><span class="k">class</span> <span class="nc">USAXS_FlyScan_Plotter</span><span class="p">(</span><span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">LinePlotter</span><span class="p">):</span>
<span class="lineno"> 79 </span>    <span class="sd">&#39;&#39;&#39;</span>
<span class="lineno"> 80 </span><span class="sd">    customize `FlyScan` handling, plot :math:`log(I)` *vs.* :math:`log(Q)`</span>
<span class="lineno"> 81 </span><span class="sd">    </span>
<span class="lineno"> 82 </span><span class="sd">    The USAXS FlyScan data is stored in a NeXus HDF5 file in a subdirectory</span>
<span class="lineno"> 83 </span><span class="sd">    below the SPEC data file.  This code uses existing code from the</span>
<span class="lineno"> 84 </span><span class="sd">    USAXS instrument to read that file.</span>
<span class="lineno"> 85 </span><span class="sd">    &#39;&#39;&#39;</span>
<span class="lineno"> 86 </span>    
<span class="lineno"> 87 </span>    <span class="k">def</span> <span class="nf">retrieve_plot_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno"> 88 </span>        <span class="sd">&#39;&#39;&#39;retrieve reduced data from the FlyScan&#39;s HDF5 file&#39;&#39;&#39;</span>
<span class="lineno"> 89 </span>        <span class="c1"># get the data from the HDF5 file</span>
<span class="lineno"> 90 </span>        <span class="n">fly_data</span> <span class="o">=</span> <span class="n">retrieve_flyScanData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">)</span>
<span class="lineno"> 91 </span>        
<span class="lineno"> 92 </span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fly_data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
<span class="lineno"> 93 </span>            <span class="k">raise</span> <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">NoDataToPlot</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">))</span>
<span class="lineno"> 94 </span>
<span class="lineno"> 95 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="s1">&#39;R&#39;</span>
<span class="lineno"> 96 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">,]</span>
<span class="lineno"> 97 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">fly_data</span>
<span class="lineno"> 98 </span>
<span class="lineno"> 99 </span>        <span class="c1"># customize the plot just a bit</span>
<span class="lineno">100 </span>        <span class="c1"># sample name as given by the user?</span>
<span class="lineno">101 </span>        <span class="n">subtitle</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">scanNum</span><span class="p">)</span>
<span class="lineno">102 </span>        <span class="n">subtitle</span> <span class="o">+=</span> <span class="s1">&#39; FlyScan: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="o">.</span><span class="n">comments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="lineno">103 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_plot_subtitle</span><span class="p">(</span><span class="n">subtitle</span><span class="p">)</span>
<span class="lineno">104 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_x_log</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="lineno">105 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_y_log</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
<span class="lineno">106 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_x_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$|\vec{Q}|, 1/\AA$&#39;</span><span class="p">)</span>
<span class="lineno">107 </span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_y_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;USAXS $R(|\vec{Q}|)$, a.u.&#39;</span><span class="p">)</span>
<span class="lineno">108 </span>    
<span class="lineno">109 </span>    <span class="k">def</span> <span class="nf">plottable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="lineno">110 </span>        <span class="sd">&#39;&#39;&#39;</span>
<span class="lineno">111 </span><span class="sd">        can this data be plotted as expected?</span>
<span class="lineno">112 </span><span class="sd">        &#39;&#39;&#39;</span>
<span class="lineno">113 </span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
<span class="lineno">114 </span>            <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="p">]</span>
<span class="lineno">115 </span>            <span class="k">if</span> <span class="n">signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="lineno">116 </span>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
<span class="lineno">117 </span>                    <span class="k">return</span> <span class="bp">True</span>
<span class="lineno">118 </span>        <span class="k">return</span> <span class="bp">False</span>
<span class="lineno">119 </span>
<span class="lineno">120 </span>
<span class="lineno">121 </span><span class="k">def</span> <span class="nf">debugging_setup</span><span class="p">():</span>
<span class="lineno">122 </span>    <span class="kn">import</span> <span class="nn">sys</span>
<span class="lineno">123 </span>    <span class="kn">import</span> <span class="nn">shutil</span>
<span class="lineno">124 </span>    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">))</span>
<span class="lineno">125 </span>    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;__usaxs__&#39;</span>
<span class="lineno">126 </span>    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="lineno">127 </span>    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="lineno">128 </span>    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">)</span>
<span class="lineno">129 </span>    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="lineno">130 </span>    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="s1">&#39;spec2nexus&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;02_03_setup.dat&#39;</span><span class="p">))</span>
<span class="lineno">131 </span>
<span class="lineno">132 </span>
<span class="lineno">133 </span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="lineno">134 </span>    <span class="n">selector</span> <span class="o">=</span> <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">Selector</span><span class="p">()</span>
<span class="lineno">135 </span>    <span class="n">selector</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;FlyScan&#39;</span><span class="p">,</span> <span class="n">USAXS_FlyScan_Plotter</span><span class="p">)</span>
<span class="lineno">136 </span>    <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot_gallery</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
<span class="lineno">137 </span>
<span class="lineno">138 </span>
<span class="lineno">139 </span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="lineno">140 </span>    <span class="c1"># debugging_setup()</span>
<span class="lineno">141 </span>    <span class="n">main</span><span class="p">()</span>
<span class="lineno">142 </span>
<span class="lineno">143 </span><span class="c1"># -----------------------------------------------------------------------------</span>
<span class="lineno">144 </span><span class="c1"># :author:    Pete R. Jemian</span>
<span class="lineno">145 </span><span class="c1"># :email:     prjemian@gmail.com</span>
<span class="lineno">146 </span><span class="c1"># :copyright: (c) 2014-2022, Pete R. Jemian</span>
<span class="lineno">147 </span><span class="c1">#</span>
<span class="lineno">148 </span><span class="c1"># Distributed under the terms of the Creative Commons Attribution 4.0 International Public License.</span>
<span class="lineno">149 </span><span class="c1">#</span>
<span class="lineno">150 </span><span class="c1"># The full license is in the file LICENSE.txt, distributed with this software.</span>
<span class="lineno">151 </span><span class="c1"># -----------------------------------------------------------------------------</span>
</pre></div>
</div>
<p>The data is then rendered in a customized log-log plot of <span class="math notranslate nohighlight">\(I(Q)\)</span>:</p>
<figure class="align-default" id="id13">
<a class="reference internal image-reference" href="_images/usaxs_flyscan.png"><img alt="_images/usaxs_flyscan.png" src="_images/usaxs_flyscan.png" style="width: 95%;" /></a>
<figcaption>
<p><span class="caption-text">USAXS <em>FlyScan</em>, handled by <code class="xref py py-class docutils literal notranslate"><span class="pre">USAXS_FlyScan_Plotter</span></code></span><a class="headerlink" href="#id13" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>When a custom scan macro handler is written and installed using code
similar to the <a class="reference internal" href="#custom-ascan-specplot"><span class="std std-ref">custom ascan</span></a> handling above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot</span><span class="o">.</span><span class="n">Selector</span><span class="p">()</span>
    <span class="n">selector</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;ascan&#39;</span><span class="p">,</span> <span class="n">Custom_Ascan</span><span class="p">)</span>
    <span class="n">spec2nexus</span><span class="o">.</span><span class="n">specplot_gallery</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>then the command line arugment handling from <code class="xref py py-meth docutils literal notranslate"><span class="pre">spec2nexus.specplot_gallery.main()</span></code>
can be accessed from the command line for help and usage information.</p>
<p>Usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>user@localhost ~/.../spec2nexus/demo $ ./ascan.py
usage: ascan.py [-h] [-r] [-d DIR] paths [paths ...]
ascan.py: error: too few arguments
</pre></div>
</div>
<p>Help:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>user@localhost ~/.../spec2nexus/demo $ ./ascan.py -h
usage: ascan.py [-h] [-r] [-d DIR] paths [paths ...]

read a list of SPEC data files (or directories) and plot images of all scans

positional arguments:
  paths              SPEC data file name(s) or directory(s) with SPEC data
                     files

optional arguments:
  -h, --help         show this help message and exit
  -r                 sort images from each data file in reverse chronolgical
                     order
  -d DIR, --dir DIR  base directory for output (default:/home/prjemian/Documen
                     ts/eclipse/spec2nexus/demo)
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">How to write a custom scan handling for <em>specplot</em></a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#data-model">Data Model</a></li>
<li><a class="reference internal" href="#steps">Steps</a></li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#change-the-plot-title-text-in-ascan-macros">Change the plot title text in <em>ascan</em> macros</a></li>
<li><a class="reference internal" href="#make-the-y-axis-log-scale">Make the <em>y</em>-axis log scale</a><ul>
<li><a class="reference internal" href="#modify-handling-of-a2scan">modify handling of <cite>a2scan</cite></a></li>
<li><a class="reference internal" href="#custom-uascan">custom <cite>uascan</cite></a></li>
</ul>
</li>
<li><a class="reference internal" href="#spec-s-hklscan-macro">SPEC’s <em>hklscan</em> macro</a></li>
<li><a class="reference internal" href="#get-xy-data-from-hdf5-file">Get <em>xy</em> data from HDF5 file</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage">Usage</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="charts.html"
                          title="previous chapter"><code class="xref py py-mod docutils literal notranslate"><span class="pre">spec2nexus.charts</span></code></a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="eznx.html"
                          title="next chapter"><code class="xref py py-mod docutils literal notranslate"><span class="pre">spec2nexus.eznx</span></code></a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/specplot_custom_scan_macro.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="eznx.html" title="spec2nexus.eznx"
             >next</a> |</li>
        <li class="right" >
          <a href="charts.html" title="spec2nexus.charts"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">spec2nexus 62.gbc635d3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="contents.html" >Contents</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">How to write a custom scan handling for <em>specplot</em></a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014-2022, Pete R. Jemian.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>