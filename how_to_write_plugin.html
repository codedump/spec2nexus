

<!doctype html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>How to write a custom plugin module &#8212; spec2nexus 24.g5a298ad documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/bizstyle.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Common Methods: spec2nexus.utils" href="utils.html" />
    <link rel="prev" title="#UXML: UXML metadata plugin" href="supplied_plugins/uxml.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="utils.html" title="Common Methods: spec2nexus.utils"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="supplied_plugins/uxml.html" title="#UXML: UXML metadata plugin"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">spec2nexus 24.g5a298ad documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="contents.html" >Contents</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="plugin.html" accesskey="U"><code class="xref py py-mod docutils literal notranslate"><span class="pre">spec2nexus.plugin</span></code></a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">How to write a custom plugin module</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="how-to-write-a-custom-plugin-module">
<span id="how-to-write-plugin"></span><h1>How to write a custom plugin module<a class="headerlink" href="#how-to-write-a-custom-plugin-module" title="Permalink to this headline">¶</a></h1>
<aside class="sidebar">
<p class="sidebar-title">The code to write plugins has changed with release 2021.0.0.</p>
<p>The changes are summarized in the
section below titled <a class="reference internal" href="#howto-changes-plugin-2021-release"><span class="std std-ref">Changes in plugin format with release 2021.0.0</span></a>.</p>
</aside>
<p><strong>Sections</strong></p>
<ul class="simple">
<li><p><a class="reference internal" href="#howto-load-plugin"><span class="std std-ref">Load a plugin module</span></a></p></li>
<li><p><a class="reference internal" href="#howto-write-plugin"><span class="std std-ref">Write a plugin module</span></a></p></li>
<li><p><a class="reference internal" href="#howto-example-pv-control-line"><span class="std std-ref">Full Example: #PV control line</span></a></p></li>
<li><p><a class="reference internal" href="#howto-example-y-control-line"><span class="std std-ref">Example to ignore a #Y control line</span></a></p></li>
<li><p><a class="reference internal" href="#howto-postprocessing"><span class="std std-ref">Postprocessing</span></a></p></li>
<li><p><a class="reference internal" href="#howto-example-postprocessing"><span class="std std-ref">Example postprocessing</span></a></p></li>
<li><p><a class="reference internal" href="#howto-summary-example"><span class="std std-ref">Summary Example Custom Plugin with postprocessing</span></a></p></li>
<li><p><a class="reference internal" href="#howto-writer"><span class="std std-ref">Custom HDF5 writer</span></a></p></li>
<li><p><a class="reference internal" href="#custom-key-match-function"><span class="std std-ref">Custom key match function</span></a></p></li>
<li><p><a class="reference internal" href="#howto-summary-requirements"><span class="std std-ref">Summary Requirements for custom plugin</span></a></p></li>
<li><p><a class="reference internal" href="#howto-changes-plugin-2021-release"><span class="std std-ref">Changes in plugin format with release 2021.0.0</span></a></p></li>
<li><p><a class="reference internal" href="#howto-footnotes"><span class="std std-ref">Footnotes</span></a></p></li>
</ul>
<p>A custom plugin module for <a class="reference internal" href="spec.html#module-spec2nexus.spec" title="spec2nexus.spec: Classes to read the contents of a SPEC data file."><code class="xref py py-mod docutils literal notranslate"><span class="pre">spec2nexus.spec</span></code></a> is provided in
a python module (Python source code file).
In this custom plugin module are subclasses for each <em>new</em>
<a class="reference internal" href="plugin.html#control-line-table"><span class="std std-ref">control line</span></a>
to be supported.  An exception will
be raised if a custom plugin module tries to provide support
for an existing control line.</p>
<section id="load-a-plugin-module">
<span id="howto-load-plugin"></span><h2>Load a plugin module<a class="headerlink" href="#load-a-plugin-module" title="Permalink to this headline">¶</a></h2>
<p>Control line handling plugins for <em>spec2nexus</em> will automatically
register themselves when their module is imported.  Be sure that
you call <a class="reference internal" href="plugin.html#spec2nexus.plugin.get_plugin_manager" title="spec2nexus.plugin.get_plugin_manager"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_plugin_manager()</span></code></a> <strong>before</strong>
you <code class="docutils literal notranslate"><span class="pre">import</span></code> your plugin code.  This step sets up the
plugin manager to automatically register your new plugin.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="kn">import</span> <span class="nn">spec2nexus.plugin</span>
<span class="lineno"> 2 </span><span class="kn">import</span> <span class="nn">spec2nexus.spec</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="c1"># get the plugin manager BEFORE you import any custom plugins</span>
<span class="lineno"> 5 </span><span class="n">manager</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">get_plugin_manager</span><span class="p">()</span>
<span class="lineno"> 6 </span>
<span class="lineno"> 7 </span><span class="kn">import</span> <span class="nn">MY_PLUGIN_MODULE</span>
<span class="lineno"> 8 </span><span class="c1"># ... more if needed ...</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="c1"># read a SPEC data file, scan 5</span>
<span class="lineno">11 </span><span class="n">spec_data_file</span> <span class="o">=</span> <span class="n">spec2nexus</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">SpecDataFile</span><span class="p">(</span><span class="s2">&quot;path/to/spec/datafile&quot;</span><span class="p">)</span>
<span class="lineno">12 </span><span class="n">scan5</span> <span class="o">=</span> <span class="n">spec_data_file</span><span class="o">.</span><span class="n">getScan</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="write-a-plugin-module">
<span id="howto-write-plugin"></span><h2>Write a plugin module<a class="headerlink" href="#write-a-plugin-module" title="Permalink to this headline">¶</a></h2>
<p>Give the custom plugin module a name ending with <code class="docutils literal notranslate"><span class="pre">.py</span></code>. As with any Python
module, the name must be unique within a directory. If the plugin is not in your
working directory, there must be a <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file in the same directory
(even if that file is empty) so that your plugin module can be loaded with
<code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">&lt;MODULE&gt;</span></code>.</p>
<p>Please view the existing plugins in <a class="reference internal" href="supplied_plugins/spec_common.html#module-spec2nexus.plugins.spec_common" title="spec2nexus.plugins.spec_common: SPEC standard data file support."><code class="xref py py-mod docutils literal notranslate"><span class="pre">spec_common</span></code></a> for
examples.  The custom plugin module should contain, at minimum one subclass of
<a class="reference internal" href="plugin.html#spec2nexus.plugin.ControlLineHandler" title="spec2nexus.plugin.ControlLineHandler"><code class="xref py py-class docutils literal notranslate"><span class="pre">spec2nexus.plugin.ControlLineHandler</span></code></a> and the keyword argument
<code class="docutils literal notranslate"><span class="pre">metaclass=AutoRegister</span></code>. The <code class="docutils literal notranslate"><span class="pre">metaclass</span></code> keyword argument allows our custom
ControlLineHandlers to register themselves when their module is imported. A
custom plugin module can contain many such handlers, as needs dictate.</p>
<aside class="sidebar">
<p class="sidebar-title">Useful <code class="docutils literal notranslate"><span class="pre">import</span></code></p>
<p>It is also useful to import the
<a class="reference internal" href="utils.html#spec2nexus.utils.strip_first_word" title="spec2nexus.utils.strip_first_word"><code class="xref py py-meth docutils literal notranslate"><span class="pre">strip_first_word()</span></code></a>
utility method.</p>
</aside>
<p>These imports are necessary to to write plugins for <em>spec2nexus</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="kn">from</span> <span class="nn">spec2nexus.plugin</span> <span class="kn">import</span> <span class="n">AutoRegister</span>
<span class="lineno">2 </span><span class="kn">from</span> <span class="nn">spec2nexus.plugin</span> <span class="kn">import</span> <span class="n">ControlLineHandler</span>
<span class="lineno">3 </span><span class="kn">from</span> <span class="nn">spec2nexus.utils</span> <span class="kn">import</span> <span class="n">strip_first_word</span>
</pre></div>
</div>
<aside class="sidebar">
<p class="sidebar-title">regular expressions</p>
<p>There are several regular expression testers available on the web.
Try this one, for example: <a class="reference external" href="https://regexpal.com/">https://regexpal.com/</a></p>
</aside>
<p><strong>Attribute: ``key`` (required)</strong></p>
<p>Each subclass must define <span class="target" id="index-0"></span>key <code class="docutils literal notranslate"><span class="pre">key</span></code> as a regular expression match for the
control line key.
It is possible to override any of the supplied plugins for scan <span class="target" id="index-1"></span>control line
control lines.
Caution is advised to avoid introducing instability.</p>
<p><strong>Attribute: ``scan_attributes_defined`` (optional)</strong></p>
<p>If your plugin creates any attributes to the
<code class="xref py py-class docutils literal notranslate"><span class="pre">spec2nexus.spec.SpecDataScan</span></code> object
(such as the hypotetical <code class="docutils literal notranslate"><span class="pre">scan.hdf5_path</span></code> and <code class="docutils literal notranslate"><span class="pre">scan.hdf5_file</span></code>),
you declare the new attributes in the
<code class="docutils literal notranslate"><span class="pre">scan_attributes_defined</span></code> list.  Such as this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="n">scan_attributes_defined</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hdf5_path&#39;</span><span class="p">,</span> <span class="s1">&#39;hdf5_file&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>Method: ``process()`` (required)</strong></p>
<p>Each subclass must also define a <code class="xref py py-meth docutils literal notranslate"><span class="pre">process()</span></code> method to process the control line.
A <code class="xref py py-class docutils literal notranslate"><span class="pre">NotImplementedError</span></code> exception is raised if <code class="docutils literal notranslate"><span class="pre">key</span></code> is not defined.</p>
<p><strong>Method: ``match_key()`` (optional)</strong></p>
<p>For difficult regular expressions (or other situations), it is possible to replace
the function that matches for a particular control line key.  Override the
handler’s <code class="xref py py-meth docutils literal notranslate"><span class="pre">match_key()</span></code> method.
For more details, see the section <a class="reference internal" href="#custom-key-match-function"><span class="std std-ref">Custom key match function</span></a>.</p>
<p><strong>Method: ``postprocess()`` (optional)</strong></p>
<p>For some types of control lines, processing can only be completed
<em>after</em> all lines of the scan have been read.  In such cases, add
a line such as this to the <code class="docutils literal notranslate"><span class="pre">process()</span></code> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scan</span><span class="o">.</span><span class="n">addPostProcessor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postprocess</span><span class="p">)</span>
</pre></div>
</div>
<p>(You <em>could</em> replace <code class="docutils literal notranslate"><span class="pre">self.key</span></code> here with some other text.
If you do, make sure that text will be unique as it is used
internally as a python dictionary key.)
Then, define a <code class="docutils literal notranslate"><span class="pre">postprocess()</span></code> method in your handler:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">postprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
    <span class="c1"># handle your custom info here</span>
</pre></div>
</div>
<p>See section <a class="reference internal" href="#howto-postprocessing"><span class="std std-ref">Postprocessing</span></a> below for more details.
See <a class="reference internal" href="supplied_plugins/spec_common.html#module-spec2nexus.plugins.spec_common" title="spec2nexus.plugins.spec_common: SPEC standard data file support."><code class="xref py py-mod docutils literal notranslate"><span class="pre">spec2nexus.plugins.spec_common</span></code></a> for many examples.</p>
<p><strong>Method: ``writer()`` (optional)</strong></p>
<p>Writing a NeXus HDF5 data file is one of the main goals of the <em>spec2nexus</em>
package.  If you intend data from your custom control line handler to
end up in the HDF5 data file, add a line such as this to either the <code class="docutils literal notranslate"><span class="pre">process()</span></code>
or <code class="docutils literal notranslate"><span class="pre">postprocess()</span></code> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scan</span><span class="o">.</span><span class="n">addH5writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, define a <code class="docutils literal notranslate"><span class="pre">writer()</span></code> method in your handler.  Here’s an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5parent</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">nxclass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describe how to store this data in an HDF5 NeXus file&quot;&quot;&quot;</span>
    <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;SPEC positioners (#P &amp; #O lines)&#39;</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">makeGroup</span><span class="p">(</span><span class="n">h5parent</span><span class="p">,</span> <span class="s1">&#39;positioners&#39;</span><span class="p">,</span> <span class="n">nxclass</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">save_dict</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">scan</span><span class="o">.</span><span class="n">positioner</span><span class="p">)</span>
</pre></div>
</div>
<p>See section <a class="reference internal" href="#howto-writer"><span class="std std-ref">Custom HDF5 writer</span></a> below for more details.</p>
</section>
<section id="full-example-pv-control-line">
<span id="howto-example-pv-control-line"></span><h2>Full Example: <strong>#PV</strong> control line<a class="headerlink" href="#full-example-pv-control-line" title="Permalink to this headline">¶</a></h2>
<p>Consider a SPEC data file (named <code class="docutils literal notranslate"><span class="pre">pv_data.txt</span></code>) with the contrived
example of a <strong>#PV</strong> control
line that associates a mnemonic with an EPICS process variable (PV).
Suppose we take this control line content to be two words (text
with no whitespace):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span>#F pv_data.txt
<span class="lineno"> 2 </span>#E 1454539891
<span class="lineno"> 3 </span>#D Wed Feb 03 16:51:31 2016
<span class="lineno"> 4 </span>#C pv_data.txt  User = spec2nexus
<span class="lineno"> 5 </span>#O0 USAXS.a2rp  USAXS.m2rp  USAXS.asrp  USAXS.msrp  mr  unused37  mst  ast
<span class="lineno"> 6 </span>#O1 msr  asr  unused42  unused43  ar  ay  dy  un47
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span>#S 1  ascan  mr 10.3467 10.3426  30 0.1
<span class="lineno"> 9 </span>#D Wed Feb 03 16:52:03 2016
<span class="lineno">10 </span>#T 0.1  (seconds)
<span class="lineno">11 </span>#P0 3.5425 6.795 7.7025 5.005 10.34465 0 0 0
<span class="lineno">12 </span>#P1 7.6 17.17188 -8.67896 -0.351 10.318091 0 18.475664 0
<span class="lineno">13 </span>#C tuning USAXS motor mr
<span class="lineno">14 </span><span class="hll">#PV mr ioc:m1
</span><span class="lineno">15 </span><span class="hll">#PV ay ioc:m2
</span><span class="lineno">16 </span><span class="hll">#PV dy ioc:m3
</span><span class="lineno">17 </span>#N 18
<span class="lineno">18 </span>#L mr    ay  dy  ar_enc  pd_range  pd_counts  pd_rate  pd_curent  I0_gain  I00_gain  Und_E  Epoch  seconds  I00  USAXS_PD  TR_diode  I0  I0
<span class="lineno">19 </span>10.34665  0.000 18.476 10.318091 1 5 481662 0.000481658 1e+07 1e+09 18.172565 33.037 0.1 199 2 1 114 114
<span class="lineno">20 </span>10.34652  0.000 18.476 10.318091 1 5 481662 0.000481658 1e+07 1e+09 18.172565 33.294 0.1 198 2 1 139 139
<span class="lineno">21 </span>10.34638  0.000 18.476 10.318091 1 5 481662 0.000481658 1e+07 1e+09 18.172565 33.553 0.1 198 2 1 181 181
<span class="lineno">22 </span>10.34625  0.000 18.476 10.318091 1 5 481662 0.000481658 1e+07 1e+09 18.172565 33.952 0.1 198 2 1 274 274
<span class="lineno">23 </span>10.34278  0.000 18.476 10.318091 1 5 481662 0.000481658 1e+07 1e+09 18.172309 41.621 0.1 198 2 1 232 232
<span class="lineno">24 </span>10.34265  0.000 18.476 10.318091 1 5 481662 0.000481658 1e+07 1e+09 18.172565 41.867 0.1 199 2 1 159 159
<span class="lineno">25 </span>#C Wed Feb 03 16:52:14 2016.  removed many data rows for this example.
</pre></div>
</div>
<p>A plugin (named <code class="docutils literal notranslate"><span class="pre">pv_plugin.py</span></code>) to handle the <code class="docutils literal notranslate"><span class="pre">#PV</span></code> control lines could be written as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="lineno"> 2 </span><span class="kn">from</span> <span class="nn">spec2nexus.plugin</span> <span class="kn">import</span> <span class="n">AutoRegister</span>
<span class="lineno"> 3 </span><span class="kn">from</span> <span class="nn">spec2nexus.plugin</span> <span class="kn">import</span> <span class="n">ControlLineHandler</span>
<span class="lineno"> 4 </span><span class="kn">from</span> <span class="nn">spec2nexus.utils</span> <span class="kn">import</span> <span class="n">strip_first_word</span>
<span class="lineno"> 5 </span>
<span class="lineno"> 6 </span><span class="k">class</span> <span class="nc">PV_ControlLine</span><span class="p">(</span><span class="n">ControlLineHandler</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">AutoRegister</span><span class="p">):</span>
<span class="lineno"> 7 </span>    <span class="sd">&#39;&#39;&#39;**#PV** -- EPICS PV associates mnemonic with PV&#39;&#39;&#39;</span>
<span class="lineno"> 8 </span>    
<span class="lineno"> 9 </span>    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;#PV&#39;</span>
<span class="lineno">10 </span>    <span class="n">scan_attributes_defined</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EPICS_PV&#39;</span><span class="p">]</span>
<span class="lineno">11 </span>    
<span class="lineno">12 </span>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">spec_obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="lineno">13 </span>        <span class="n">args</span> <span class="o">=</span> <span class="n">strip_first_word</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="lineno">14 </span>        <span class="n">mne</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="lineno">15 </span>        <span class="n">pv</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="lineno">16 </span>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">spec_obj</span><span class="p">,</span> <span class="s2">&quot;EPICS_PV&quot;</span><span class="p">):</span>
<span class="lineno">17 </span>            <span class="c1"># use OrderedDict since it remembers the order we found these</span>
<span class="lineno">18 </span>            <span class="n">spec_obj</span><span class="o">.</span><span class="n">EPICS_PV</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
<span class="lineno">19 </span>        <span class="n">spec_obj</span><span class="o">.</span><span class="n">EPICS_PV</span><span class="p">[</span><span class="n">mne</span><span class="p">]</span> <span class="o">=</span> <span class="n">pv</span>
</pre></div>
</div>
<p>When the scan parser encounters the <strong>#PV</strong> lines in our SPEC data file,
it will call this
<code class="xref py py-meth docutils literal notranslate"><span class="pre">process()</span></code> code with the full text of the line and the
spec scan object where
this data should be stored.
We will choose to store this (following the pattern of other data
names in <a class="reference internal" href="spec.html#spec2nexus.spec.SpecDataFileScan" title="spec2nexus.spec.SpecDataFileScan"><code class="xref py py-class docutils literal notranslate"><span class="pre">SpecDataFileScan</span></code></a>) as
<code class="docutils literal notranslate"><span class="pre">scan_obj.EPICS_PV</span></code> using a dictionary.</p>
<p>It is up to the user what to do with the <code class="docutils literal notranslate"><span class="pre">scan_obj.EPICS_PV</span></code> data.
We will not consider the <code class="docutils literal notranslate"><span class="pre">write()</span></code> method in this example.
(We will not write this infromation to a NeXus HDF5 file.)</p>
<p>We can then write a python program (named <code class="docutils literal notranslate"><span class="pre">pv_example.py</span></code>) that will
load the data file and interpret it using our custom plugin:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="kn">import</span> <span class="nn">spec2nexus.plugin</span>
<span class="lineno"> 2 </span><span class="kn">import</span> <span class="nn">spec2nexus.spec</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="c1"># call get_plugin_manager() BEFORE you import any custom plugins</span>
<span class="lineno"> 5 </span><span class="n">manager</span> <span class="o">=</span> <span class="n">spec2nexus</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">get_plugin_manager</span><span class="p">()</span>
<span class="lineno"> 6 </span>
<span class="lineno"> 7 </span><span class="c1"># show our plugin is not loaded</span>
<span class="lineno"> 8 </span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;known: &quot;</span><span class="p">,</span> <span class="s2">&quot;#PV&quot;</span> <span class="ow">in</span> <span class="n">manager</span><span class="o">.</span><span class="n">registry</span><span class="p">)</span> <span class="c1"># expect False</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span><span class="kn">import</span> <span class="nn">pv_plugin</span>
<span class="lineno">11 </span><span class="c1"># show that our plugin is registered</span>
<span class="lineno">12 </span><span class="k">print</span><span class="p">(</span><span class="s2">&quot;known: &quot;</span><span class="p">,</span> <span class="s2">&quot;#PV&quot;</span> <span class="ow">in</span> <span class="n">manager</span><span class="o">.</span><span class="n">registry</span><span class="p">)</span> <span class="c1"># expect True</span>
<span class="lineno">13 </span>
<span class="lineno">14 </span><span class="c1"># read a SPEC data file, scan 1</span>
<span class="lineno">15 </span><span class="n">spec_data_file</span> <span class="o">=</span> <span class="n">spec2nexus</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">SpecDataFile</span><span class="p">(</span><span class="s2">&quot;pv_data.txt&quot;</span><span class="p">)</span>
<span class="lineno">16 </span><span class="n">scan</span> <span class="o">=</span> <span class="n">spec_data_file</span><span class="o">.</span><span class="n">getScan</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="lineno">17 </span>
<span class="lineno">18 </span><span class="c1"># Do we have our PV data?</span>
<span class="lineno">19 </span><span class="k">print</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="s2">&quot;EPICS_PV&quot;</span><span class="p">))</span>    <span class="c1"># expect True</span>
<span class="lineno">20 </span><span class="k">print</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">EPICS_PV</span><span class="p">)</span>
</pre></div>
</div>
<p>The output of our program:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span>known:  False
<span class="lineno">2 </span>known:  True
<span class="lineno">3 </span>False
<span class="lineno">4 </span>True
<span class="lineno">5 </span>OrderedDict([(&#39;mr&#39;, &#39;ioc:m1&#39;), (&#39;ay&#39;, &#39;ioc:m2&#39;), (&#39;dy&#39;, &#39;ioc:m3&#39;)])
</pre></div>
</div>
</section>
<section id="example-to-ignore-a-y-control-line">
<span id="howto-example-y-control-line"></span><h2>Example to ignore a <strong>#Y</strong> control line<a class="headerlink" href="#example-to-ignore-a-y-control-line" title="Permalink to this headline">¶</a></h2>
<p>Suppose a control line in a SPEC data file must be ignored.
For example, suppose a SPEC file contains this control line: <code class="docutils literal notranslate"><span class="pre">#Y</span> <span class="pre">1</span> <span class="pre">2</span> <span class="pre">3</span> <span class="pre">4</span> <span class="pre">5</span></code>.
Since there is no standard handler for this control line,
we create one that ignores processing by doing nothing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="kn">from</span> <span class="nn">spec2nexus.plugin</span> <span class="kn">import</span> <span class="n">AutoRegister</span>
<span class="lineno"> 2 </span><span class="kn">from</span> <span class="nn">spec2nexus.plugin</span> <span class="kn">import</span> <span class="n">ControlLineHandler</span>
<span class="lineno"> 3 </span>
<span class="lineno"> 4 </span><span class="k">class</span> <span class="nc">Ignore_Y_ControlLine</span><span class="p">(</span><span class="n">ControlLineHandler</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">AutoRegister</span><span class="p">):</span>
<span class="lineno"> 5 </span>    <span class="sd">&#39;&#39;&#39;</span>
<span class="lineno"> 6 </span><span class="sd">    **#Y** -- as in ``#Y 1 2 3 4 5``</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span><span class="sd">    example: ignore any and all #Y control lines</span>
<span class="lineno"> 9 </span><span class="sd">    &#39;&#39;&#39;</span>
<span class="lineno">10 </span>
<span class="lineno">11 </span>    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;#Y&#39;</span>
<span class="lineno">12 </span>
<span class="lineno">13 </span>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">spec_obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="lineno">14 </span>        <span class="k">pass</span> <span class="c1"># do nothing</span>
</pre></div>
</div>
</section>
<section id="postprocessing">
<span id="howto-postprocessing"></span><h2>Postprocessing<a class="headerlink" href="#postprocessing" title="Permalink to this headline">¶</a></h2>
<p>Sometimes, it is necessary to defer a step of processing until after the complete
scan data has been read.  One example is for 2-D or 3-D data that has been acquired
as a vector rather than matrix.  The matrix must be constructed only after all the
scan data has been read.  Such postprocessing is handled in a method in a plugin file.
The postprocessing method is registered from the control line handler by calling the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">addPostProcessor()</span></code> method of the <code class="docutils literal notranslate"><span class="pre">spec_obj</span></code> argument received by the
handler’s <code class="xref py py-meth docutils literal notranslate"><span class="pre">process()</span></code> method.  A key name <a class="footnote-reference brackets" href="#id8" id="id1">1</a> is supplied when registering to avoid
registering this same code more than once.  The postprocessing function will be called
with the instance of <a class="reference internal" href="spec.html#spec2nexus.spec.SpecDataFileScan" title="spec2nexus.spec.SpecDataFileScan"><code class="xref py py-class docutils literal notranslate"><span class="pre">SpecDataFileScan</span></code></a> as its only argument.</p>
<p>An important role of the postprocessing is to store the result in the scan object.
It is important not to modify other data in the scan object.  Pick an attribute
named similarly to the plugin (e.g., MCA configuration uses the <strong>MCA</strong> attribute,
UNICAT metadata uses the <strong>metadata</strong> attribute, …)  This attribute will define
where and how the data from the plugin is available.  The <code class="xref py py-meth docutils literal notranslate"><span class="pre">writer()</span></code> method
(see <a class="reference internal" href="#howto-writer"><span class="std std-ref">below</span></a>) is one example of a user of this attribute.</p>
<section id="example-postprocessing">
<span id="howto-example-postprocessing"></span><h3>Example postprocessing<a class="headerlink" href="#example-postprocessing" title="Permalink to this headline">¶</a></h3>
<p>Consider the <strong>#U</strong> control line example above.  For some contrived reason,
we wish to store the sum of the numbers as a separate number, but only after
all the scan data has been read.  This can be done with the simple expression:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="n">spec_obj</span><span class="o">.</span><span class="n">U_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">spec_obj</span><span class="o">.</span><span class="n">U</span><span class="p">)</span>
</pre></div>
</div>
<p>To build a postprocessing method, we write:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="k">def</span> <span class="nf">contrived_summation</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="lineno">2 </span>    <span class="sd">&#39;&#39;&#39;</span>
<span class="lineno">3 </span><span class="sd">    add up all the numbers in the #U line</span>
<span class="lineno">4 </span>
<span class="lineno">5 </span><span class="sd">    :param SpecDataFileScan scan: data from a single SPEC scan</span>
<span class="lineno">6 </span><span class="sd">    &#39;&#39;&#39;</span>
<span class="lineno">7 </span>    <span class="n">scan</span><span class="o">.</span><span class="n">U_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">U</span><span class="p">)</span>
</pre></div>
</div>
<p>To register this postprocessing method, place this line in the <code class="xref py py-meth docutils literal notranslate"><span class="pre">process()</span></code>
of the handler:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="n">spec_obj</span><span class="o">.</span><span class="n">addPostProcessor</span><span class="p">(</span><span class="s1">&#39;contrived_summation&#39;</span><span class="p">,</span> <span class="n">contrived_summation</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="summary-example-custom-plugin-with-postprocessing">
<span id="howto-summary-example"></span><h3>Summary Example Custom Plugin with postprocessing<a class="headerlink" href="#summary-example-custom-plugin-with-postprocessing" title="Permalink to this headline">¶</a></h3>
<p>Gathering all parts of the examples above, the custom plugin module is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno"> 1 </span><span class="kn">from</span> <span class="nn">spec2nexus.plugin</span> <span class="kn">import</span> <span class="n">AutoRegister</span>
<span class="lineno"> 2 </span><span class="kn">from</span> <span class="nn">spec2nexus.plugin</span> <span class="kn">import</span> <span class="n">ControlLineHandler</span>
<span class="lineno"> 3 </span><span class="kn">from</span> <span class="nn">spec2nexus.utils</span> <span class="kn">import</span> <span class="n">strip_first_word</span>
<span class="lineno"> 4 </span>
<span class="lineno"> 5 </span><span class="k">class</span> <span class="nc">User_ControlLine</span><span class="p">(</span><span class="n">ControlLineHandler</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">AutoRegister</span><span class="p">):</span>
<span class="lineno"> 6 </span>    <span class="sd">&#39;&#39;&#39;**#U** -- User data (#U user1 user2 user3)&#39;&#39;&#39;</span>
<span class="lineno"> 7 </span>
<span class="lineno"> 8 </span>    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;#U&#39;</span>
<span class="lineno"> 9 </span>
<span class="lineno">10 </span>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">spec_obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="lineno">11 </span>        <span class="n">args</span> <span class="o">=</span> <span class="n">strip_first_word</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="lineno">12 </span>        <span class="n">user1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="lineno">13 </span>        <span class="n">user2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="lineno">14 </span>        <span class="n">user3</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="lineno">15 </span>        <span class="n">spec_obj</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="p">[</span><span class="n">user1</span><span class="p">,</span> <span class="n">user2</span><span class="p">,</span> <span class="n">user3</span><span class="p">]</span>
<span class="lineno">16 </span>        <span class="n">spec_obj</span><span class="o">.</span><span class="n">addPostProcessor</span><span class="p">(</span><span class="s1">&#39;contrived_summation&#39;</span><span class="p">,</span> <span class="n">contrived_summation</span><span class="p">)</span>
<span class="lineno">17 </span>
<span class="lineno">18 </span>
<span class="lineno">19 </span><span class="k">def</span> <span class="nf">contrived_summation</span><span class="p">(</span><span class="n">scan</span><span class="p">):</span>
<span class="lineno">20 </span>    <span class="sd">&#39;&#39;&#39;</span>
<span class="lineno">21 </span><span class="sd">    add up all the numbers in the #U line</span>
<span class="lineno">22 </span>
<span class="lineno">23 </span><span class="sd">    :param SpecDataFileScan scan: data from a single SPEC scan</span>
<span class="lineno">24 </span><span class="sd">    &#39;&#39;&#39;</span>
<span class="lineno">25 </span>    <span class="n">scan</span><span class="o">.</span><span class="n">U_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">U</span><span class="p">)</span>
<span class="lineno">26 </span>
<span class="lineno">27 </span>
<span class="lineno">28 </span><span class="k">class</span> <span class="nc">Ignore_Y_ControlLine</span><span class="p">(</span><span class="n">ControlLineHandler</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">AutoRegister</span><span class="p">):</span>
<span class="lineno">29 </span>    <span class="sd">&#39;&#39;&#39;**#Y** -- as in ``#Y 1 2 3 4 5``&#39;&#39;&#39;</span>
<span class="lineno">30 </span>
<span class="lineno">31 </span>    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;#Y&#39;</span>
<span class="lineno">32 </span>
<span class="lineno">33 </span>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">spec_obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="lineno">34 </span>        <span class="k">pass</span>
</pre></div>
</div>
</section>
</section>
<section id="custom-hdf5-writer">
<span id="howto-writer"></span><h2>Custom HDF5 writer<a class="headerlink" href="#custom-hdf5-writer" title="Permalink to this headline">¶</a></h2>
<p>A custom HDF5 writer method defines how the data from the
<a class="reference internal" href="#howto-postprocessing"><span class="std std-ref">plugin</span></a>
will be written to the HDF5+NeXus data file.  The writer will
be called with several arguments:</p>
<p><strong>h5parent</strong>: <em>obj</em> : the HDF5 group that will hold this plugin’s data</p>
<p><strong>writer</strong>:   <em>obj</em> : instance of <a class="reference internal" href="writer.html#spec2nexus.writer.Writer" title="spec2nexus.writer.Writer"><code class="xref py py-class docutils literal notranslate"><span class="pre">spec2nexus.writer.Writer</span></code></a> that manages the content of the HDF5 file</p>
<p><strong>scan</strong>:     <em>obj</em> : instance of <a class="reference internal" href="spec.html#spec2nexus.spec.SpecDataFileScan" title="spec2nexus.spec.SpecDataFileScan"><code class="xref py py-class docutils literal notranslate"><span class="pre">spec2nexus.spec.SpecDataFileScan</span></code></a> containing this scan’s data</p>
<p><strong>nxclass</strong>:  <em>str</em> : (optional) name of NeXus base class to be created</p>
<p>Since the file is being written according to the NeXus data standard <a class="footnote-reference brackets" href="#id9" id="id2">2</a>,
use the NeXus base classes <a class="footnote-reference brackets" href="#id10" id="id3">3</a> as references for how to structure the data
written by the custom HDF5 writer.</p>
<p>One responsibility of a custom HDF5 writer method is to create
<em>unique</em> names for every object written in the <em>h5parent</em> group.
Usually, this will be a <em>NXentry</em> <a class="footnote-reference brackets" href="#id11" id="id4">4</a> group.  You can determine the
NeXus base class of this group using code such as this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">h5parent</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;NX_class&#39;</span><span class="p">]</span>
<span class="lineno">2 </span><span class="go">&lt;&lt;&lt; NXentry</span>
</pre></div>
</div>
<p>If your custom HDF5 writer
must create group and you are uncertain which base class to select,
it is recommended to use a <strong>NXcollection</strong> <a class="footnote-reference brackets" href="#id12" id="id5">5</a> (an unvalidated catch-all
base class) which can store any content.
But, you are encouraged to find one of the other NeXus base classes that
best fits your data.  Look at the source code of the supplied plugins
for examples.</p>
<p>The writer uses the <a class="reference internal" href="eznx.html#module-spec2nexus.eznx" title="spec2nexus.eznx: (Easy NeXus) support reading &amp; writing NeXus HDF5 files using h5py"><code class="xref py py-mod docutils literal notranslate"><span class="pre">spec2nexus.eznx</span></code></a> module to create and write
the various parts of the HDF5 file.</p>
<p>Here is an example <code class="xref py py-meth docutils literal notranslate"><span class="pre">writer()</span></code> method from the
<a class="reference internal" href="supplied_plugins/unicat.html#module-spec2nexus.plugins.unicat" title="spec2nexus.plugins.unicat: Metadata in SPEC data files as defined by APS UNICAT."><code class="xref py py-mod docutils literal notranslate"><span class="pre">spec2nexus.plugins.unicat</span></code></a> module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span> <span class="k">def</span> <span class="nf">writer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h5parent</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">nxclass</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
<span class="lineno">2 </span>     <span class="sd">&#39;&#39;&#39;Describe how to store this data in an HDF5 NeXus file&#39;&#39;&#39;</span>
<span class="lineno">3 </span>     <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">4 </span>         <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;SPEC metadata (UNICAT-style #H &amp; #V lines)&#39;</span>
<span class="lineno">5 </span>         <span class="n">group</span> <span class="o">=</span> <span class="n">eznx</span><span class="o">.</span><span class="n">makeGroup</span><span class="p">(</span><span class="n">h5parent</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="n">nxclass</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
<span class="lineno">6 </span>         <span class="n">writer</span><span class="o">.</span><span class="n">save_dict</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">scan</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="custom-key-match-function">
<span id="id6"></span><h2>Custom key match function<a class="headerlink" href="#custom-key-match-function" title="Permalink to this headline">¶</a></h2>
<p>The default test that a given line
matches a specific <a class="reference internal" href="plugin.html#spec2nexus.plugin.ControlLineHandler" title="spec2nexus.plugin.ControlLineHandler"><code class="xref py py-class docutils literal notranslate"><span class="pre">spec2nexus.plugin.ControlLineHandler</span></code></a> subclass
is to use a regular expression match.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span> <span class="k">def</span> <span class="nf">match_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="lineno">2 </span>     <span class="sd">&#39;&#39;&#39;default regular expression match, based on self.key&#39;&#39;&#39;</span>
<span class="lineno">3 </span>     <span class="n">t</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<span class="lineno">4 </span>     <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
<span class="lineno">5 </span>         <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<span class="lineno">6 </span>             <span class="k">return</span> <span class="bp">True</span>
<span class="lineno">7 </span>     <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</div>
<p>In some cases, that may
prove tedious or difficult, such as when testing for a
floating point number with optional preceding white space
at the start of a line.  This is typical for data lines in a scan
or continued lines from an MCA spectrum.  in such cases, the handler
can override the <code class="xref py py-meth docutils literal notranslate"><span class="pre">match_key()</span></code> method.  Here is an example
from <a class="reference internal" href="supplied_plugins/spec_common.html#spec2nexus.plugins.spec_common.SPEC_DataLine" title="spec2nexus.plugins.spec_common.SPEC_DataLine"><code class="xref py py-class docutils literal notranslate"><span class="pre">SPEC_DataLine</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="lineno">1 </span> <span class="k">def</span> <span class="nf">match_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="lineno">2 </span>     <span class="sd">&#39;&#39;&#39;</span>
<span class="lineno">3 </span><span class="sd">     Easier to try conversion to number than construct complicated regexp</span>
<span class="lineno">4 </span><span class="sd">     &#39;&#39;&#39;</span>
<span class="lineno">5 </span>     <span class="k">try</span><span class="p">:</span>
<span class="lineno">6 </span>         <span class="nb">float</span><span class="p">(</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
<span class="lineno">7 </span>         <span class="k">return</span> <span class="bp">True</span>
<span class="lineno">8 </span>     <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="lineno">9 </span>         <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</div>
</section>
<section id="summary-requirements-for-custom-plugin">
<span id="howto-summary-requirements"></span><h2>Summary Requirements for custom plugin<a class="headerlink" href="#summary-requirements-for-custom-plugin" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>file can go in your working directory or any directory that has <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file</p></li>
<li><p>multiple control line handlers can go in a single file</p></li>
<li><p>for each control line:</p>
<ul>
<li><p>subclass <a class="reference internal" href="plugin.html#spec2nexus.plugin.ControlLineHandler" title="spec2nexus.plugin.ControlLineHandler"><code class="xref py py-class docutils literal notranslate"><span class="pre">spec2nexus.plugin.ControlLineHandler</span></code></a></p></li>
<li><p>add <code class="docutils literal notranslate"><span class="pre">metaclass=AutoRegister</span></code> keyword argument to auto-register the plugin</p></li>
<li><p>import the module you defined (FIXME:  check this and revise)</p></li>
<li><p>identify the control line pattern</p></li>
<li><p>define <code class="docutils literal notranslate"><span class="pre">key</span></code> with a regular expression to match <a class="footnote-reference brackets" href="#id13" id="id7">6</a></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">key</span></code> is used to identify control line handlers</p></li>
<li><p>redefine existing supported <span class="target" id="index-2"></span>control line control lines to replace supplied behavior (use caution!)</p></li>
<li><p>Note: <code class="docutils literal notranslate"><span class="pre">key=&quot;scan</span> <span class="pre">data&quot;</span></code> is used to process the scan data: <a class="reference internal" href="supplied_plugins/spec_common.html#spec2nexus.plugins.spec_common.SPEC_DataLine" title="spec2nexus.plugins.spec_common.SPEC_DataLine"><code class="xref py py-meth docutils literal notranslate"><span class="pre">spec2nexus.plugins.spec_common.SPEC_DataLine()</span></code></a></p></li>
</ul>
</li>
<li><p>define <code class="xref py py-meth docutils literal notranslate"><span class="pre">process()</span></code> to handle the supplied text</p></li>
<li><p>define <code class="xref py py-meth docutils literal notranslate"><span class="pre">writer()</span></code> to write the in-memory data structure from this plugin to HDF5+NeXus data file</p></li>
<li><p>(optional) define <code class="xref py py-meth docutils literal notranslate"><span class="pre">match_key()</span></code> to override the default regular expression to match the key</p></li>
</ul>
</li>
<li><p>for each postprocessing function:</p>
<ul>
<li><p>write the function</p></li>
<li><p>register the function with spec_obj.addPostProcessor(key_name, the_function) in the handler’s <code class="xref py py-meth docutils literal notranslate"><span class="pre">process()</span></code></p></li>
</ul>
</li>
</ul>
<hr class="docutils" />
</section>
<section id="changes-in-plugin-format-with-release-2021-0-0">
<span id="howto-changes-plugin-2021-release"></span><h2>Changes in plugin format with release 2021.0.0<a class="headerlink" href="#changes-in-plugin-format-with-release-2021-0-0" title="Permalink to this headline">¶</a></h2>
<p>With release <em>2021.0.0</em>, the code to setup plugins has changed.
The new code allows all plugins in a module to auto-register themselves
<em>as long as the module is imported</em>.
<strong>All</strong> custom plugins must be modified and import code revised
to work with new system.
See the <a class="reference internal" href="supplied_plugins/spec_common.html#module-spec2nexus.plugins.spec_common" title="spec2nexus.plugins.spec_common: SPEC standard data file support."><code class="xref py py-mod docutils literal notranslate"><span class="pre">spec2nexus.plugins.spec_common</span></code></a> source code for many examples.</p>
<ul class="simple">
<li><p>SAME: The basics of writing the plugins remains the same.</p></li>
<li><p>CHANGED: The method of registering the plugins has changed.</p></li>
<li><p>CHANGED: The declaration of each plugin has changed.</p></li>
<li><p>CHANGED: The name of each plugin file has been relaxed.</p></li>
<li><p>CHANGED: Plugin files do not have to be in their own directory.</p></li>
<li><p>REMOVED: The <code class="docutils literal notranslate"><span class="pre">SPEC2NEXUS_PLUGIN_PATH</span></code> environment variable has been eliminated.</p></li>
</ul>
<hr class="docutils" />
</section>
<section id="footnotes">
<span id="howto-footnotes"></span><h2>Footnotes<a class="headerlink" href="#footnotes" title="Permalink to this headline">¶</a></h2>
<dl class="footnote brackets">
<dt class="label" id="id8"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>The key name must be unique amongst all postprocessing functions.
A good choice is the name of the postprocessing function itself.</p>
</dd>
<dt class="label" id="id9"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p><a class="reference external" href="https://nexusformat.org">https://nexusformat.org</a></p>
</dd>
<dt class="label" id="id10"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p><a class="reference external" href="https://download.nexusformat.org/doc/html/classes/base_classes/">https://download.nexusformat.org/doc/html/classes/base_classes/</a></p>
</dd>
<dt class="label" id="id11"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p><a class="reference external" href="https://download.nexusformat.org/doc/html/classes/base_classes/NXentry.html">https://download.nexusformat.org/doc/html/classes/base_classes/NXentry.html</a></p>
</dd>
<dt class="label" id="id12"><span class="brackets"><a class="fn-backref" href="#id5">5</a></span></dt>
<dd><p><a class="reference external" href="https://download.nexusformat.org/doc/html/classes/base_classes/NXcollection.html">https://download.nexusformat.org/doc/html/classes/base_classes/NXcollection.html</a></p>
</dd>
<dt class="label" id="id13"><span class="brackets"><a class="fn-backref" href="#id7">6</a></span></dt>
<dd><p>It is possible to override the default regular expression match
in the subclass with a custom match function.  See the
<a class="reference internal" href="supplied_plugins/spec_common.html#spec2nexus.plugins.spec_common.SPEC_DataLine.match_key" title="spec2nexus.plugins.spec_common.SPEC_DataLine.match_key"><code class="xref py py-meth docutils literal notranslate"><span class="pre">match_key()</span></code></a>
method for an example.</p>
</dd>
</dl>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">How to write a custom plugin module</a><ul>
<li><a class="reference internal" href="#load-a-plugin-module">Load a plugin module</a></li>
<li><a class="reference internal" href="#write-a-plugin-module">Write a plugin module</a></li>
<li><a class="reference internal" href="#full-example-pv-control-line">Full Example: <strong>#PV</strong> control line</a></li>
<li><a class="reference internal" href="#example-to-ignore-a-y-control-line">Example to ignore a <strong>#Y</strong> control line</a></li>
<li><a class="reference internal" href="#postprocessing">Postprocessing</a><ul>
<li><a class="reference internal" href="#example-postprocessing">Example postprocessing</a></li>
<li><a class="reference internal" href="#summary-example-custom-plugin-with-postprocessing">Summary Example Custom Plugin with postprocessing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#custom-hdf5-writer">Custom HDF5 writer</a></li>
<li><a class="reference internal" href="#custom-key-match-function">Custom key match function</a></li>
<li><a class="reference internal" href="#summary-requirements-for-custom-plugin">Summary Requirements for custom plugin</a></li>
<li><a class="reference internal" href="#changes-in-plugin-format-with-release-2021-0-0">Changes in plugin format with release 2021.0.0</a></li>
<li><a class="reference internal" href="#footnotes">Footnotes</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="supplied_plugins/uxml.html"
                          title="previous chapter">#UXML: UXML metadata plugin</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="utils.html"
                          title="next chapter">Common Methods: <code class="xref py py-mod docutils literal notranslate"><span class="pre">spec2nexus.utils</span></code></a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/how_to_write_plugin.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="utils.html" title="Common Methods: spec2nexus.utils"
             >next</a> |</li>
        <li class="right" >
          <a href="supplied_plugins/uxml.html" title="#UXML: UXML metadata plugin"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">spec2nexus 24.g5a298ad documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="contents.html" >Contents</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="plugin.html" ><code class="xref py py-mod docutils literal notranslate"><span class="pre">spec2nexus.plugin</span></code></a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">How to write a custom plugin module</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014-2022, Pete R. Jemian.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>